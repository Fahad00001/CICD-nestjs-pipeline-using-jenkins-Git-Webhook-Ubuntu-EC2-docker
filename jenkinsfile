pipeline {
    agent any   

    environment {
        CONTAINER_NAME = 'nestjs-app'
        IMAGE_NAME = 'nestjs-image'
        EMAIL_RECIPIENT = 'fahad.iq010@gmial.com'
        PORT = '3000'

    }

    stages {
        stage ('Clone reop'){
            steps{
                git branch: 'main', url:'https://github.com/Fahad00001/CICD-nestjs-pipeline-using-jenkins-Git-Webhook-Ubuntu-EC2-docker.git'
            }
        }

        stage(Build Docker Image){
            steps{
                sh 'docker build -t $IMAGE_NAME'
            }
        }

         stage(Stop & Remove Previous Container){
            steps{
                sh '''
                     docker stop $CONTAINER_NAME || true
                     docker rm $CONTAINER_NAME || true

                '''
            }
        }

        stage(Docker Container Run){
            steps{
                sh '''
                     docker run -d -p ${PORT}:${PORT} --name $CONTAINER_NAME $IMAGE_NAME

                '''
            }
        }

        stage(Send Email Notification){
            steps{
                emailtext{
                    subject:"Nestjs app deloyed successfully on EC2",
                    body:"The Nestjs application has been successfully deployed and is running on port http://http://13.210.204.71:${PORT}.",
                    to: "${EMAIL_RECIPIENT}"
                }
            }
        }


    }   

}